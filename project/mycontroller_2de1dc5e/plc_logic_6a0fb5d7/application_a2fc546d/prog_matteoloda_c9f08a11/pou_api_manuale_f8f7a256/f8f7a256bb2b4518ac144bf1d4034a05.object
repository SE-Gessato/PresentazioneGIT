{"payload":{"meta":{"Graph":{"@Type":"81297157","@Value":{"Guid":"(Guid)f8f7a256-bb2b-4518-ac14-4bf1d4034a05","ParentGuid":"(Guid)a2fc546d-6c23-43ef-bc2a-160f144a5843","Name":"(string)POU_API_Manuale","Properties":{"@Type":"2c41fa04:IDictionary","@Value":[{"@Key":"(Guid)829a18f2-c514-4f6e-9634-1df173429203","@Value":{"@Type":"829a18f2","@Value":{"ParentObjects":{"@Type":"fa2ee218:IDictionary","@Value":[{"@Key":"(Guid)d9b2b2cc-ea99-4c3b-aa42-1e5c49e65b84","@Value":"(Guid)c9f08a11-bc99-4c1b-88ff-280dfd7d11e0"}]}}}}]},"TypeGuid":"(Guid)6f9dac99-8de1-4efc-8465-68ac443b7d08","EmbeddedTypeGuids":{"@Type":"[Guid]","@Value":["(Guid)a9ed5b7e-75c5-4651-af16-d2c27e98cb94","(Guid)3b83b776-fb25-43b8-99f2-3c507c9143fc"]}}},"TypeInfos":{"2c41fa04":"{2c41fa04-1834-41c1-816e-303c7aa2c05b}","81297157":"{81297157-7ec9-45ce-845e-84cab2b88ade}","829a18f2":"{829a18f2-c514-4f6e-9634-1df173429203}","fa2ee218":"{fa2ee218-a39b-4b6d-b249-49dbddbd168a}","Guid":"System.Guid","string":"System.String"}},"object":{"Graph":{"@Type":"6f9dac99","@Value":{"SpecialFunc":{"@Type":"0db3d7bb:Enum","@Value":"None"},"Implementation":{"@Type":"3b83b776","@Value":{"TextDocument":{"@Type":"f3878285","@Value":{"TextBlobForSerialisation":"(string)\n// esempio string richiesta GET\n// '/api/v2/export/?start=2023-06-20T04:44:30Z&end=2023-06-20T04:45:00Z&unit_ids=36389'\nString_Resource := CONCAT('/api/v2/export/?start=',scada_data_ora_start) ; // prepara string get\nString_Resource := CONCAT(String_Resource,'&end=') ;// prepara string get\nString_Resource := CONCAT(String_Resource,scada_data_ora_end) ;// prepara string get\nString_Resource := CONCAT(String_Resource,'&') ;// prepara string get\n//String_Resource := CONCAT(String_Resource,String_Unit_ID[puntatore_GET]) ;// prepara string get\n\n\n// parametri per FB connessione\nPARAM_ConnectToServer.etProtocol \t\t:= TCPUDP.ET_TlsProtocol.TLSv13 ;  \t\t\t\t// impostazione Parametri per FB seguente \nPARAM_ConnectToServer.etCertVerifyMode \t:= TCPUDP.ET_CertVerifyMode.TrustedOnly  ;\t \t// impostazione Parametri per FB seguente\n\n// parametri per FB GET\n//Get_String_Resource := '/api/v2/export/?start=2023-06-20T04:44:30Z&end=2023-06-20T04:45:00Z&unit_ids=36389'   ; // \nGet_String_Resource := String_Resource  ; // \nGet_Additional_Header :=  'Authorization: Basic emVudHJpeDpyaXZlcmxha2U='   ; // 'Authorization: Basic b3BlcmF0b3I6ZGU0NzU5MzE='  codificato in base64\n\t\n\n\n\n//---------------------------------------------------------------------------------------------------------------------\n\n// time_polling\nIF time_polling<5 THEN // timepolling è usato come ritardo tra richieste , tempo min 5 ms\n\ttime_polling := 5 ; // tempo min 5 ms\nEND_IF\nFB_Rit_Start_Polling(\n\tIN:=NOT Dns_leggi_ip , \n\tPT:= INT_TO_TIME(time_polling), \n\tQ=> , \n\tET=> );\nIF \tFB_Rit_Start_Polling.Q THEN\n\tDns_leggi_ip:=TRUE;\nEND_IF\n\n//---------------------------------------------------------------------------------------------------------------------\n\nFB_DNSCLIENT(\n\ti_xEnable\t\t\t:=  Dns_leggi_ip, \n\ti_xExecute\t\t\t:=  FB_DNSCLIENT.q_xActive AND FB_DNSCLIENT.q_xReady, \n\ti_sDnsServerIP\t\t:= '8.8.8.8', // dns di google\n\ti_uiDnsServerPort\t:= , \n\ti_sDomainName\t\t:=  'ehp-data.com',  // dominio\n\tq_xActive\t\t\t=> , \n\tq_xReady\t\t\t=> , \n\tq_xBusy\t\t\t\t=> , \n\tq_xDone\t\t\t\t=> x_dns_OK, \n\tq_xError\t\t\t=> x_dns_ERR, \n\tq_etResult\t\t\t=> , \n\tq_sResultMsg\t\t=> , \n\tq_uiNumberOfIpAddresses\t=> , \n\tq_astDnsAddressInfo\t\t=> ); // in questo (.q_astDnsAddressInfo[0].sIpAddress) l'indirizzo IP del server\n\t\t\n\nIF FB_DNSCLIENT.q_xDone THEN\n\tind_IP_Dominio := FB_DNSCLIENT.q_astDnsAddressInfo[0].sIpAddress\t;\n\txExecPing := TRUE ;\n\nEND_IF\nIF FB_DNSCLIENT.q_xError THEN\n\tDns_leggi_ip := FALSE ;\n\tn_dns_ERR := n_dns_ERR +1 ;\nEND_IF\n\n\n\t\n// se abilito il ping il polling ritarda causa esecuzione del ping\nFB_PING(\n\ti_xExecute:= xExecPing, \n\ti_sDeviceIP:= ind_IP_Dominio , // '135.181.0.23'\n\ti_timTimeout:= T#5S, \n\tq_xBusy=> , \n\tq_xDone=> x_Ping_OK, \n\tq_xError=> x_Ping_ERR, \n\tq_etResult=> , \n\tq_sResultMsg=> ResultPing);\n\nIF x_Ping_OK THEN\n\tgx_StartCertHandling:=TRUE;\nEND_IF\nritarda_CertHandling(in:=gx_StartCertHandling, pt:=T#500MS);\nIF ritarda_CertHandling.Q THEN\n\tCertificate_Handling();\nEND_IF\n\n\n//---------------------------------------------------------------------------------------------------------------------\nIF FB_DNSCLIENT.q_xDone THEN // x_Ping_OK\n\tcmd_CONNESSIONE := TRUE ;\nEND_IF\nhttp_client_state :=  FB_HTTP_CLIENT.State ;\n\nIF cmd_CONNESSIONE AND FB_HTTP_CLIENT.State = SE_HTTP.ET_State.Idle THEN \t\t\t\n\tFB_HTTP_CLIENT.ConnectToServer(\n\t\ti_sServerIP\t\t\t:= ind_IP_Dominio , // Indirizzo_IP_server   '135.181.0.23' \n\t\ti_uiServerPort\t\t:= 443 , //443\n\t\ti_xUseTls\t\t\t:= TRUE , // true con port 443 , false per port 80\n\t\ti_stTlsSettings\t\t:= PARAM_ConnectToServer, \n\t\tq_xError\t=> , \n\t\tq_etResult\t=>  xResultConnect, \n\t\tq_sResultMsg=> );\nEND_IF\n\nIF FB_HTTP_CLIENT.State=SE_HTTP.ET_State.Connected THEN\n\tFB_HTTP_CLIENT.Get( \n\t\ti_sResource := Get_String_Resource ,\n\t\ti_sHost:= 'ehp-data.com' ,// ehp-data.com\n\t\ti_anyAdditionalHeader:= Get_Additional_Header, // string Header    'Authorization: Basic b3BlcmF0b3I6ZGU0NzU5MzE='\n\t\ti_anyResponseBuffer:= Get_Response_Buffer, // string_xy.000 // ricezione dati\n\t\tq_xError=> get_error, \n\t\tq_etResult=> Get_Result , \n\t\tq_sResultMsg=> Get_result_Msg );\t\nEND_IF\n\n\nACT_Gestione_String_Lettura();\n\n\n\n\n//---------------------------------------------------------------------------------------------------------------------\nIF cmd_Reset_Disconnect OR FB_HTTP_CLIENT.State = SE_HTTP.ET_State.Error THEN\n\tFB_HTTP_CLIENT.DisconnectFromServer(\n\t\tq_xError=> , \n\t\tq_etResult=> , \n\t\tq_sResultMsg=> );\n\tFB_HTTP_CLIENT.Reset();\n\tcmd_Reset_Disconnect := FALSE ;\n\tget_error := FALSE ;\n\tDns_leggi_ip := FALSE ;\n\txExecPing := FALSE ;\n\tcmd_CONNESSIONE := FALSE ;\n\tGet_Strart_request := FALSE ;\n\tGet_Response_Buffer:='';\n\tGet_Additional_Header:='';\n\tGet_result_Msg:='';\n\tpuntatore_GET := puntatore_GET +1 ;\n\tIF puntatore_GET>19 THEN\n\t\tpuntatore_GET:=0;\n\tEND_IF\nEND_IF\n\n\n\nn_bcd := int_to_bcd(puntatore_GET); // sposto valore puntatore in uscite plc formato bcd\nq0:= n_bcd.0 ; // uscita plc\nq1:= n_bcd.1 ;// uscita plc\nq2:= n_bcd.2 ;// uscita plc\nq3:= n_bcd.3 ;// uscita plc\n\n\n\nIF reset_n_richieste THEN\n\tdiag_n_richieste_OK := 0 ;\n\tdiag_n_richieste_ERR := 0;\n\tn_dns_ERR:=0;\n\treset_n_richieste := FALSE ;\nEND_IF\n\nF_Blink_01(ENABLE:=TRUE , TIMELOW:=T#10M , TIMEHIGH:=T#5S , OUT=> );\n\nritardo_primo_ntp(IN:= NOT xNtp_first_time_done, PT:= T#30S, Q=> , ET=> );\nimpulso_primo_ntp(IN:= ritardo_primo_ntp.Q, PT:= T#1S, Q=> xNtp_first_time, ET=> );\nIF xNtp_first_time THEN\n\txNtp_first_time_done:=TRUE;\nEND_IF\n\nFB_NTP.i_stTimeRequest.i_sServerIp := '95.217.220.251' ;\nFB_NTP.i_stTimeRequest.i_timServerTimeOut := T#3000MS;\nFB_NTP(\n\ti_xEnable:= F_Blink_01.OUT OR ntp_manual OR xNtp_first_time, //\n\ti_xExecute:= FB_NTP.q_xActive AND FB_NTP.q_xReady, \n\ti_xSyncRtc:= TRUE, \n\ti_diTimeZone:= , \n\ti_uiMaxRtcOffset:= , \n\ti_stTimeRequest:= , \n\tq_xActive=> , \n\tq_xReady=> , \n\tq_xBusy=> , \n\tq_xDone=> , \n\tq_stTimeResponse=> , \n\tq_xError=> , \n\tq_etResult=> , \n\tq_sResultMsg=> );\n\n\t\n\n\n\n\n\n\n\n\n","LineInfoPersistence":"(string)f8f7a256-bb2b-4518-ac14-4bf1d4034a05_Impl_LineIds"}}}},"Interface":{"@Type":"a9ed5b7e","@Value":{"TextDocument":{"@Type":"f3878285","@Value":{"TextBlobForSerialisation":"(string)PROGRAM POU_API_Manuale\nVAR CONSTANT\nString_Unit_ID : ARRAY[0..19] OF STRING := ['formula_ids=2925', 'unit_ids=36389', 'unit_ids=36384', 'unit_ids=36387', 'formula_ids=2931', 'unit_ids=36342', 'unit_ids=36337', 'unit_ids=36340', 'formula_ids=2929', 'unit_ids=36351', 'unit_ids=36346', 'unit_ids=36349', 'formula_ids=2930', 'unit_ids=36371', 'unit_ids=36366', 'unit_ids=36369', 'formula_ids=2928', 'unit_ids=36380', 'unit_ids=36375', 'unit_ids=36378'] ;\nEND_VAR\n\nVAR\nString_Resource: STRING(200);\n\n// Lib usate in questa Demo : SE_HTTP ( x funzioni di connessione e scritture https )\n// Lib usate in questa Demo : TCPUDP ( x funzione dns )\n// Lib usate in questa Demo : SysTimeRtc ( x funzione timestamp )\t\t\nFB_DNSCLIENT\t\t\t\t: TCPUDP.FB_DnsClient;\t\t\t// dichiarazione dell'FB DNS per recupero indirizzo ip del server\nFB_HTTP_CLIENT\t\t\t\t: SE_HTTP.FB_HttpClient;\t\t// dichiarazione dell'FB CLIENT per connessione , scrittura dati e disconnessione\nPARAM_ConnectToServer\t\t: SE_HTTP.TlsSettings;\t\t\t// ingresso dell'FB : FB_HTTP_CLIENT.ConnectToServer\t\n\nGet_Result: SE_HTTP.ET_Result;\n\nGet_result_Msg : STRING ;\nGet_Additional_Header: STRING;\nGet_Response_Buffer : STRING(5000); // ricezione dati  , per export opcua max(254)\nget_error: BOOL;\nGet_Strart_request: BOOL;\nGet_String_Resource: STRING(SE_HTTP.GPL.Gc_uiMaxLengthOfResource);\nFB_PING: TCPUDP.FB_Ping;\nResultPing: STRING(80);\nxResultPing: BOOL;\nxExecPing : BOOL ;\nxResultConnect: SE_HTTP.ET_Result;\ntemp_string: STRING(1000);\nkey: STRING(INT#5);\nkey_stamp: STRING(INT#9);\ni: INT;\nb: INT;\nc: INT;\nkey2: STRING(INT#1);\na: INT;\n\nx: INT;\n\n\tsts: INT;\n\tsts_prec: INT;\n\t\n\tFB_Rit_Start_Polling: TON;\n\tDns_leggi_ip: BOOL;\ncmd_Reset_Disconnect: BOOL;\ncmd_CONNESSIONE: BOOL;\n\tn_bcd: BYTE;\n\tFB_NTP: TIMS.FB_SntpClient;\n\tF_Blink_01: BLINK;\n\tntp_manual: BOOL;\n\t\n\n\nx_Ping_OK  : BOOL;\nx_Ping_ERR : BOOL;\n\n\txNtp_first_time: BOOL;\n\txNtp_first_time_done: BOOL;\n\nritardo_primo_ntp : TON;\nimpulso_primo_ntp : TP;\n\nritarda_CertHandling : TON;\nEND_VAR\n","LineInfoPersistence":"(string)f8f7a256-bb2b-4518-ac14-4bf1d4034a05_Decl_LineIds"}}}},"UniqueIdGenerator":"(string)1688","POULevel":{"@Type":"8e575c5b:Enum","@Value":"Standard"},"ChildObjectGuids":{"@Type":"ArrayList:IList","@Value":[]},"AddAttributeSubsequent":"(bool)False"}},"TypeInfos":{"0db3d7bb":"{0db3d7bb-cde0-4416-9a7b-ce49a0124323}","3b83b776":"{3b83b776-fb25-43b8-99f2-3c507c9143fc}","6f9dac99":"{6f9dac99-8de1-4efc-8465-68ac443b7d08}","8e575c5b":"{8e575c5b-1d37-49c6-941b-5c0ec7874787}","a9ed5b7e":"{a9ed5b7e-75c5-4651-af16-d2c27e98cb94}","ArrayList":"System.Collections.ArrayList","bool":"System.Boolean","f3878285":"{f3878285-8e4f-490b-bb1b-9acbb7eb04db}","string":"System.String"}}},"FormatVersion":"1.0"}